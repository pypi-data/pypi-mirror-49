<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PyContract</title>
  <link type="image/vnd.microsoft.icon" href="favicon.ico">
  <link href="https://unpkg.com/nes.css/css/nes.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Press+Start+2P" rel="stylesheet">
  <script type="text/javascript" src="js/jquery-2.0.3.min.js"></script>
  <!--<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/6.3.3/rxjs.umd.min.js"></script>-->
  <script type="text/javascript" src="js/vue.min.js"></script>
  <script type="text/javascript" src="js/vue-cookies.js"></script>
  <script type="text/javascript" src="js/axios.min.js"></script>
  <script type="text/javascript" src="js/8bitwallet.js"></script>
</head>

<!-- base style -->
<style>
  html, body, pre, code, kbd, samp {
    font-family: "Press Start 2P";
    font-size: 16px;
  }
  body {
    margin: 20px;
    padding: 10px;
  }
  div {
    margin: 3px;
    padding: 3px;

  }
</style>

<body>
<div id="app">
  <header>
  <div>
    <h1>
      <img class="nes-avatar is-medium" src="image/python-min-x64.png">
      <span>PyContract 8bit Wallet {{version}}</span>
    </h1>
    PyContract 8bit wallet is an HTML-based GUI interface bind to bc4py library.
    You can control accounts, send to, view history and action contracts.
    We use <a href="https://nostalgic-css.github.io/NES.css/">NES.css</a>
    for CSS template.
  </div>
</header>

  <!-- select buttons -->
  <div id="select-button">
    <button type="button" onclick="topSelect(this.innerHTML);" class="nes-btn is-primary">System</button>
    <button type="button" onclick="topSelect(this.innerHTML);" class="nes-btn">BlockChain</button>
    <button type="button" onclick="topSelect(this.innerHTML);" class="nes-btn">Account</button>
    <button type="button" onclick="topSelect(this.innerHTML);" class="nes-btn">Sendto</button>
    <button type="button" onclick="topSelect(this.innerHTML);" class="nes-btn">Contract</button>
    <button type="button" onclick="topSelect(this.innerHTML);" class="nes-btn">AboutMe</button>
  </div>

  <!-- status -->
  <div id="status">
    <section class="nes-container with-title">
      <transition>
        <h2 v-if="status==='guest'" class="title">status (guest)</h2>
        <h2 v-if="status==='login'" class="title">status ({{username}})</h2>
      </transition>
      <section class="nes-container with-title">
        <h2 class="title">message</h2>
        <span class="common-message">no message.</span>
      </section>
      <span>no waiting work</span>
    </section>
  </div>

  <div id="info">
    <!-- System -->
    <section class="nes-container with-title" style="display: block;">
      <h2 class="title">System</h2>
      <transition>
        <div v-if="status==='guest'">
          <div class="nes-field">
            <label>username<input v-model="username" type="text" class="nes-input"></label>
            <label>password<input v-model="password" type="password" class="nes-input"></label>
            <label>endpoint<input v-model="endpoint" type="url" class="nes-input"></label>
          </div>
          <section class="nes-container">
            <button onclick="loginCheck();" class="nes-btn is-primary">Login</button>
            <label>cookie<input v-model="useCookie" type="checkbox" disabled=""></label>
            <label>websocket<input v-model="useWebsocket" type="checkbox" disabled=""></label>
          </section>
        </div>
        <div v-if="status==='login'" id="login-info">
          You are logging in by "{{username}}".
          <button onclick="tryLogout();" class="nes-btn is-warnig">Logout</button>
        </div>
      </transition>
    </section>

    <!-- BlockChain -->
    <section class="nes-container with-title" style="display: none;">
      <h2 class="title">BlockChain</h2>
      <button type="button" onclick="updateBlockInfo();" class="nes-btn is-primary">Update block info</button>
      <section class="nes-container with-title">
        <h3 class="title">best block</h3>
        <pre id="bestblock-info">no info.</pre>
      </section>
      <section class="nes-container with-title">
        <h3 class="title">mining info</h3>
        <pre id="mining-info">no info.</pre>
      </section>
    </section>

    <!-- Account -->
    <section class="nes-container with-title" style="display: none;">
      <h2 class="title">Account</h2>
      <button type="button" onclick="updateAccountInfo();" class="nes-btn is-primary">Update</button>
      <section class="nes-container with-title">
        <h3 class="title">balance</h3>
        <div id="account-balance">no info.</div>
      </section>
      <section class="nes-container with-title">
        <h3 class="title">history</h3>
        <div id="account-history">no info.</div>
      </section>
    </section>

    <!-- Sendto -->
    <section class="nes-container with-title" style="display: none;">
      <h2 class="title">Sendto</h2>
      <section class="nes-container with-title">
        <h3 class="title">from</h3>
        <select v-model="sendInfo.sender" onclick="updateAccounts(this);" onchange="updateSender(this);">
          <option v-for="(value, key) in accounts" :key="key">{{key}}</option>
        </select>
        <ul class="nes-list is-disc">
          <li v-for="(value, key) in accounts[sendInfo.sender]" :key="key">
            CoinID={{key}}  Balance={{value}}
          </li>
        </ul>
      </section>
      <section class="nes-container with-title">
        <h3 class="title">to</h3>
        <div>
          <button onclick="addRecipients(this);" type="button" class="nes-btn is-primary" style="width: 20%;">Add</button>
          <input type="text" class="nes-input" style="width: 70%;" placeholder="Address">
          <input type="number" class="nes-input" style="width: 40%;" placeholder="CoinID" value="0">
          <input type="number" class="nes-input" style="width: 50%;" placeholder="Amount">
        </div>
        <ul class="nes-list is-disc">
          <li v-for="(value, index) in sendInfo.recipients">
            <button onclick="removeRecipients(this);" type="button" class="nes-btn">Del</button>
            {{value[0]}}  {{value[1]}}  {{value[2]}}
          </li>
        </ul>
      </section>
      <section class="nes-container with-title">
        <h3 class="title">message</h3>
        <div class="field">
          <label for="sendMessage">{{sendMessageInfo}}</label>
          <textarea v-model="sendInfo.message" id="sendMessage" class="nes-textarea"></textarea>
        </div>
      </section>
      <section class="nes-container">
        <button onclick="trySendto(this);" class="nes-btn is-primary">Sendto</button>
        <button onclick="resetSendto();" class="nes-btn is-warning">Reset</button>
        <pre id="send-result"></pre>
      </section>
    </section>

    <!-- Contract -->
    <section class="nes-container with-title" style="display: none;">
      <h2 class="title">Contract</h2>
      <select v-model="contractInfo.address">
        <option v-for="(value, key) in contracts" :key="key">{{key}}</option>
      </select>
      <select v-model="contractInfo.method" v-if="contractInfo.address!==null">
        <option v-for="(value, key) in contracts[contractInfo.address][1]">{{key}}</option>
      </select>
      <div v-if="contractInfo.address!==null&&contractInfo.method!==null">
        <section class="nes-container with-title">
          <h3 class="title">about</h3>
          {{contracts[contractInfo.address][0]}}
        </section>
        <section class="nes-container with-title">
          <h3 class="title">params</h3>
          <ul id="contract-params" class="nes-list is-disc">
            <li v-for="(item, index) in contracts[this.contractInfo.address][1][contractInfo.method]">
              <section class="nes-container with-title">
                <h4 class="title">argument {{index}}</h4>
                description: {{item[0]}}<br>type format: {{item[1]}}<br>
                <input type="text" oninput="inputJsonCheck(this);" style="width: 100%; color: black;">
              </section>
            </li>
          </ul>
        </section>
        <section class="nes-container">
          <button type="button" onclick="tryContract(this);" class="nes-btn is-primary">Send</button>
          <pre></pre>
        </section>
      </div>

    </section>

    <!-- AboutMe -->
    <section class="nes-container with-title" style="display: none;">
      <h2 class="title">AboutMe</h2>
      PyContract 8bit wallet is...
      <ul>
        <li>version {{version}} now</li>
        <li>Designed for only on local environment</li>
        <li>Made for normal users to attract interests, so have only basic functions.</li>
        <li>Created by <a href="http://twitter.com/namuyan_mine">@namuyan_mine</a></li>
        <li>Bind to bc4py library</li>
        <li> not guaranteed, use at your own risk</li>
        <li>Licensed by MIT</li>
      </ul>
      Release note
      <ul>
        <li>2018/12/31 Version up 0.0.1 and marge to develop branch</li>
        <li>2018/12/29 start development</li>
      </ul>
    </section>
  </div>

</div>
<div>
  <footer class="footer">
    <p><a href="http://github.com/namuyan/bc4py">PyContract 8bit wallet</a>
      <span>-</span>
      <a href="https://twitter.com/namuyan_mine">@namuyan_mine</a></p>
  </footer>
</div>
</body>
<script type="text/javascript">

  const knownContracts = {
      // Address: String
      'CJ4QZ7FDEH5J7B2O3OLPASBHAFEDP6I7UKI2YMKF': [
          // about: String
          'high low game (example contract)',
          // method: {name : params, ..}
          {
              // params: [[String, typeof], ..]
              game: [['User select (High=true, Low=false)', 'boolean'],]
          }
      ],
  };

  const app = new Vue({
      el: '#app',
      data: {
          version: '0.0.1',
          username: '',
          password: '',
          status: 'guest', // guest or login
          endpoint: location.origin,
          useCookie: false,
          useWebsocket: false,
          accounts: {},  // {accountName: {coinID: balance, ...}, ..}
          sendInfo: {
              sender: null,  // SenderName
              recipients: [],  // [[Address, CoinID, Amount],.. ]
              message: ''
          },
          contracts: knownContracts,
          contractInfo: {
              address: null,
              method: null,
          }
      },
      computed: {
          sendMessageInfo: function () {
              function isHex (input) {
                  const hexRegEx = /([0-9]|[a-f])/gim;
                  return typeof input === 'string' &&
                      (input.match(hexRegEx) || []).length === input.length
              }
              const msg = this.sendInfo.message;
              if (msg.length===0) {
                  return 'no message';
              }else if (msg.length%2===0 && isHex(msg)){
                  return 'Hex string';
              } else {
                  return 'Plain message';
              }
          }
      }
  });

  // on init
  setTimeout(function () {
      console.log("no init work");
      actionCookie('init');
      updateBlockInfo();
  });
</script>
<!--
 TODO:
 小数点は後で反映する。あんなの飾りです。偉い人にはそれが分からんのですよ。
 必要最低限の機能のみ。
 -->
</html>
