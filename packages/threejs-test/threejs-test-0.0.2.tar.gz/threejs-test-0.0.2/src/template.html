<!DOCTYPE html>
<html lang="en">
<head>
	<title>three.js webgl - buffergeometry - particles</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<link type="text/css" rel="stylesheet" href="../src/main.css">
	<script src="../src/build/d3.v4.min.js"></script>
</head>
<body>
,
<div id="container"></div>
<div id="info"><a href="http://threejs.org" target="_blank" rel="noopener">three.js</a> webgl - buffergeometry - particles</div>

<script type="module">

	import * as THREE from '../src/build/three.module.js';
	import  Stats  from '../src/jsm/libs/stats.module.js';
	import { GUI } from '../src/jsm/libs/dat.gui.module.js';
	import { OrbitControls } from '../src/jsm/controls/OrbitControls.js';

	var container, stats;
	var camera, scene, renderer, camera_controls;
	var points;
	var points_csv;


	init();
	animate();

	function init() {
		d3.csv("../data/INPUT_PC_CSV", function(data) {
			points_csv = data;
			gui_controls.redraw_points();
		});

		container = document.getElementById('container');

		//

		camera = new THREE.PerspectiveCamera(27, window.innerWidth / window.innerHeight, 0.1, 1000);
		camera.position.z = 2;

		renderer = new THREE.WebGLRenderer({alpha: true});
		renderer.setPixelRatio(window.devicePixelRatio);
		renderer.setSize(window.innerWidth, window.innerHeight);

		scene = new THREE.Scene();
		// scene.background = new THREE.Color( "rgb(200,95,38)" );
		// scene.fog = new THREE.Fog( 0x050505, 2000, 3500 );

		camera_controls = new OrbitControls(camera, renderer.domElement);

		var gui_controls = new function () {
			this.size = 5;
			this.opacity = 1.0;
			this.defaultColor=true;
			this.uniColor=0xFFFFFF;

			this.redraw_points = function () {
				if (scene.getObjectByName("particles")) {
					scene.remove(scene.getObjectByName("particles"));
				}
				createParticles(gui_controls.size,
								gui_controls.opacity,
								gui_controls.defaultColor,
								gui_controls.uniColor);

			};
		};

		var gui = new GUI();
		gui.add(gui_controls, 'size', 1, 10).onChange(gui_controls.redraw_points);
		gui.add(gui_controls, 'opacity', 0, 1).onChange(gui_controls.redraw_points);
		gui.add(gui_controls, 'defaultColor').onChange(gui_controls.redraw_points);
		gui.addColor(gui_controls, 'uniColor').onChange(gui_controls.redraw_points);
		render();

		function createParticles(size, opacity, defaultColor, uniColor) {
			var geometry = new THREE.BufferGeometry();
			var material = new THREE.PointsMaterial({
				size: size,
				vertexColors: defaultColor,
				transparent: true,
				sizeAttenuation: false,
				opacity: opacity,
				color: uniColor,
			});
			var positions = [];
			var colors = [];
			var color = new THREE.Color();

			for (var i = 0; i < points_csv.length; i++) {
				var x = points_csv[i].x;
				var y = points_csv[i].y;
				var z = points_csv[i].z;
				var vx = points_csv[i].r;
				var vy = points_csv[i].g;
				var vz = points_csv[i].b;
				positions.push(x, y, z);
				color.setRGB(vx, vy, vz);
				colors.push(color.r, color.g, color.b);
			}
			geometry.addAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
			geometry.addAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
			geometry.computeBoundingSphere();

			points = new THREE.Points(geometry, material);
			points.name = "particles";
			scene.add(points);
		}

		container.appendChild( renderer.domElement );
		stats = new Stats();
		container.appendChild( stats.dom );
		window.addEventListener( 'resize', onWindowResize, false );
	}

	function onWindowResize() {
		camera.aspect = window.innerWidth / window.innerHeight;
		camera.updateProjectionMatrix();
		renderer.setSize( window.innerWidth, window.innerHeight );
	}

	function animate() {
		requestAnimationFrame( animate );
		camera_controls.update();
		renderer.render( scene, camera );
		render();
		stats.update();

	}

	function render() {
		renderer.render( scene, camera );
	}



</script>

</body>
</html>